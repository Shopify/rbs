#include "rbs/ast.h"
#include "rbs/ruby_objs.h"
#include <stdlib.h>

rbs_node_list_t* rbs_node_list_new(void) {
    rbs_node_list_t *list = (rbs_node_list_t *)malloc(sizeof(rbs_node_list_t));
    list->head = NULL;
    list->tail = NULL;
    list->length = 0;
    list->cached_ruby_value = rb_ary_new();

    rb_gc_register_mark_object(list->cached_ruby_value);

    return list;
}

void rbs_node_list_free(rbs_node_list_t *list) {
    rbs_node_list_node_t *current = list->head;
    while (current != NULL) {
        rbs_node_list_node_t *next = current->next;
        free(current);
        current = next;
    }
    free(list);
}

void rbs_node_list_append(rbs_node_list_t *list, rbs_node_t *node) {
    rb_gc_register_mark_object(node->cached_ruby_value);

    rbs_node_list_node_t *new_node = (rbs_node_list_node_t *)malloc(sizeof(rbs_node_list_node_t));
    new_node->node = node;
    new_node->next = NULL;

    if (list->tail == NULL) {
        list->head = new_node;
        list->tail = new_node;
    } else {
        list->tail->next = new_node;
        list->tail = new_node;
    }
    list->length++;

    rb_ary_push(list->cached_ruby_value, node->cached_ruby_value);
}

<%-
nodes.each do |node|

parameters = node.constructor_parameters
-%>
<%= node.c_struct_name %> *<%= node.c_base_name %>_new(<%= parameters.map { |field| "#{field.c_type} #{field.name}" }.join(", ") %>) {
    <%= node.c_struct_name %> *instance = (<%= node.c_struct_name %> *)calloc(1, sizeof(<%= node.c_struct_name %>));

    <%-parameters.filter(&:ruby_object?).each do |field| -%>
    rb_gc_register_mark_object(<%= field.name %>);
    <%- end -%>

    <%- if node.c_base_name == "rbs_types_classinstance" -%>
    VALUE ruby_name = name->base.cached_ruby_value;
    VALUE ruby_value = rbs_class_instance(ruby_name, args, location);
    <%- elsif node.c_base_name == "rbs_types_interface" -%>
    VALUE ruby_name = name->base.cached_ruby_value;
    VALUE ruby_value = rbs_interface(ruby_name, args, location);
    <%- elsif node.c_base_name == "rbs_types_alias" -%>
    VALUE ruby_name = name->base.cached_ruby_value;
    VALUE ruby_value = rbs_alias(ruby_name, args, location);
    <%- elsif node.c_base_name == "rbs_typename" -%>
    VALUE ruby_value = rbs_type_name(namespace, name);
    <%- elsif node.c_base_name == "rbs_types_function_param" -%>
    VALUE ruby_type = type->cached_ruby_value;
    VALUE ruby_value = rbs_function_param(ruby_type, name, location);
    <%- elsif node.c_base_name == "rbs_types_optional" -%>
    VALUE ruby_type = type->cached_ruby_value;
    VALUE ruby_value = rbs_optional(ruby_type, location);
    <%- elsif node.c_base_name == "rbs_types_proc" -%>
    VALUE ruby_value = rbs_proc(type, block, location, self_type);
    <%- elsif node.c_base_name == "rbs_types_classsingleton" -%>
    VALUE ruby_name = name->base.cached_ruby_value;
    VALUE ruby_value = rbs_class_singleton(ruby_name, location);
    <%- elsif node.c_base_name == "rbs_types_bases_bool"-%>
    VALUE ruby_value = rbs_bases_bool(location);
    <%- elsif node.c_base_name == "rbs_types_bases_bottom"-%>
    VALUE ruby_value = rbs_bases_bottom(location);
    <%- elsif node.c_base_name == "rbs_types_bases_class"-%>
    VALUE ruby_value = rbs_bases_class(location);
    <%- elsif node.c_base_name == "rbs_types_bases_instance"-%>
    VALUE ruby_value = rbs_bases_instance(location);
    <%- elsif node.c_base_name == "rbs_types_bases_nil"-%>
    VALUE ruby_value = rbs_bases_nil(location);
    <%- elsif node.c_base_name == "rbs_types_bases_self"-%>
    VALUE ruby_value = rbs_bases_self(location);
    <%- elsif node.c_base_name == "rbs_types_bases_top"-%>
    VALUE ruby_value = rbs_bases_top(location);
    <%- elsif node.c_base_name == "rbs_types_bases_void"-%>
    VALUE ruby_value = rbs_bases_void(location);
    <%- elsif node.c_base_name == "rbs_types_bases_any"-%>
    VALUE ruby_value = rbs_bases_any(location);
    <%- elsif node.c_base_name == "rbs_types_literal"-%>
    VALUE ruby_value = rbs_literal(literal, location);
    <%- elsif node.c_base_name == "rbs_types_variable"-%>
    VALUE ruby_value = rbs_variable(name, location);
    <%- elsif node.c_base_name == "rbs_types_tuple"-%>
    VALUE ruby_value = rbs_tuple(types, location);
    <%- elsif node.c_base_name == "rbs_types_record"-%>
    VALUE ruby_value = rbs_record(all_fields, location);
    <%- elsif node.c_base_name == "rbs_types_intersection"-%>
    VALUE ruby_value = rbs_intersection(types, location);
    <%- elsif node.c_base_name == "rbs_types_union"-%>
    VALUE ruby_value = rbs_union(types, location);
    <%- elsif node.c_base_name == "rbs_ast_typeparam"-%>
    VALUE ruby_value = rbs_ast_type_param(name, variance, upper_bound, default_type, location);
    <%- elsif node.c_base_name == "rbs_methodtype"-%>
    VALUE ruby_type_params = type_params->cached_ruby_value;
    VALUE ruby_value = rbs_method_type(ruby_type_params, type, block, location);
    <%- elsif node.c_base_name == "rbs_ast_declarations_global"-%>
    VALUE ruby_type = type->cached_ruby_value;
    VALUE ruby_value = rbs_ast_decl_global(name, ruby_type, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_declarations_constant"-%>
    VALUE ruby_name = name->base.cached_ruby_value;
    VALUE ruby_type = type->cached_ruby_value;
    VALUE ruby_value = rbs_ast_decl_constant(ruby_name, ruby_type, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_declarations_typealias"-%>
    VALUE ruby_name = name->base.cached_ruby_value;
    VALUE ruby_type_params = type_params->cached_ruby_value;
    VALUE ruby_type = type->cached_ruby_value;
    VALUE ruby_annotations = annotations->cached_ruby_value;
    VALUE ruby_value = rbs_ast_decl_type_alias(ruby_name, ruby_type_params, ruby_type, ruby_annotations, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_annotation"-%>
    VALUE ruby_value = rbs_ast_annotation(string, location);
    <%- elsif node.c_base_name == "rbs_ast_members_methoddefinition"-%>
    VALUE ruby_annotations = annotations->cached_ruby_value;
    VALUE ruby_value = rbs_ast_members_method_definition(
        name,
        kind,
        overloads,
        ruby_annotations,
        location,
        comment,
        overloading,
        visibility
    );
    <%- elsif node.c_base_name == "rbs_ast_members_include"-%>
    VALUE ruby_annotations = annotations->cached_ruby_value;
    VALUE ruby_value = rbs_ast_members_include(name, args, ruby_annotations, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_members_extend"-%>
    VALUE ruby_annotations = annotations->cached_ruby_value;
    VALUE ruby_value = rbs_ast_members_extend(name, args, ruby_annotations, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_members_prepend"-%>
    VALUE ruby_annotations = annotations->cached_ruby_value;
    VALUE ruby_value = rbs_ast_members_prepend(name, args, ruby_annotations, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_members_instancevariable"-%>
    VALUE ruby_type = type->cached_ruby_value;
    VALUE ruby_value = rbs_ast_members_instance_variable(name, ruby_type, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_members_classvariable"-%>
    VALUE ruby_value = rbs_ast_members_class_variable(name, type, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_members_classinstancevariable"-%>
    VALUE ruby_value = rbs_ast_members_class_instance_variable(name, type, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_members_alias"-%>
    VALUE ruby_annotations = annotations->cached_ruby_value;
    VALUE ruby_value = rbs_ast_members_alias(new_name, old_name, kind, ruby_annotations, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_members_public"-%>
    VALUE ruby_value = rbs_ast_members_public(location);
    <%- elsif node.c_base_name == "rbs_ast_members_private"-%>
    VALUE ruby_value = rbs_ast_members_private(location);
    <%- elsif node.c_base_name == "rbs_ast_members_attrreader"-%>
    VALUE ruby_value = rbs_ast_members_attr_reader(name, type, ivar_name, kind, annotations, location, comment, visibility);
    <%- elsif node.c_base_name == "rbs_ast_members_attrwriter"-%>
    VALUE ruby_value = rbs_ast_members_attr_writer(name, type, ivar_name, kind, annotations, location, comment, visibility);
    <%- elsif node.c_base_name == "rbs_ast_members_attraccessor"-%>
    VALUE ruby_value = rbs_ast_members_attr_accessor(name, type, ivar_name, kind, annotations, location, comment, visibility);
    <%- elsif node.c_base_name == "rbs_ast_declarations_interface"-%>
    VALUE ruby_value = rbs_ast_decl_interface(name, type_params, members, annotations, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_declarations_module"-%>
    VALUE ruby_value = rbs_ast_decl_module(name, type_params, self_types, members, annotations, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_declarations_modulealias"-%>
    VALUE ruby_value = rbs_ast_decl_module_alias(new_name, old_name, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_declarations_class_super"-%>
    VALUE ruby_value = rbs_ast_decl_class_super(name, args, location);
    <%- elsif node.c_base_name == "rbs_ast_declarations_class"-%>
    VALUE ruby_value = rbs_ast_decl_class(name, type_params, super_class, members, annotations, location, comment);
    <%- elsif node.c_base_name == "rbs_ast_declarations_classalias"-%>
    VALUE ruby_value = rbs_ast_decl_class_alias(new_name, old_name, location, comment);
    <%- elsif node.c_base_name == "rbs_namespace"-%>
    VALUE ruby_value = rbs_namespace(path, absolute);
    <%- elsif node.c_base_name == "rbs_ast_directives_use"-%>
    VALUE ruby_value = rbs_ast_directives_use(clauses, location);
    <%- end -%>

    rb_gc_register_mark_object(ruby_value);

    *instance = (<%= node.c_struct_name %>) {
        .base = (rbs_node_t) {
            .cached_ruby_value = ruby_value,
            .type = <%= node.c_type_enum_name %>
        },
        <%- node.fields.each do |field| -%>
        .<%= field.name %> = <%= field.ruby_object? ? field.name : "ruby_#{field.name}" %>,
        <%- end -%>
    };

    return instance;
}

<%- end -%>

const char* get_class_name(VALUE o) {
    VALUE klass = rb_class_of(o);      // Get the class of the object
    VALUE klass_name = rb_class_name(klass);  // Get the name of the class
    const char* name = StringValueCStr(klass_name);  // Convert to C string
    return name;
}

VALUE rbs_struct_to_ruby_value(rbs_node_t *instance) {
    if (instance == NULL) {
        fprintf(stderr, "Tried to call rbs_struct_to_ruby_value(NULL)\n");
        exit(1);
    }

    if (instance->type == RBS_TYPES_ZZZTMPNOTIMPLEMENTED) {
        // Special case: skip assertions/translation below.
        return instance->cached_ruby_value;
    }

    VALUE ruby_value = instance->cached_ruby_value;

    if (ruby_value == Qnil || ruby_value == Qundef) {
        fprintf(stderr, "cached_ruby_value is NULL\n");
        exit(1);
    }

    const char *class_name = get_class_name(ruby_value);

    switch (instance->type) {
        <%- nodes.each do |node| -%>
        case <%= node.c_type_enum_name %>: {
            if (strcmp(class_name, "<%= node.full_name %>") != 0) {
                fprintf(stderr, "Expected class name: <%= node.full_name %>, got %s\n", class_name);
                exit(1);
            }
            break;
        }
        <%- end -%>
    }

    return instance->cached_ruby_value;
}
