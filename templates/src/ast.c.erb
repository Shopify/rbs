#include "rbs/ast.h"
#include <stdlib.h>

<%- nodes.each do |node| -%>
<%= node.c_struct_name %> *<%= node.c_base_name %>_new(VALUE ruby_value, <%= node.fields.map { |field| "VALUE #{field.name}" }.join(", ") %>) {
    <%= node.c_struct_name %> *instance = (<%= node.c_struct_name %> *)calloc(1, sizeof(<%= node.c_struct_name %>));

    rb_gc_register_mark_object(ruby_value);
    <%- node.fields.each do |field| -%>
    rb_gc_register_mark_object(<%= field.name %>);
    <%- end -%>

    *instance = (<%= node.c_struct_name %>) {
        .base = (rbs_node_t) {
            .cached_ruby_value = ruby_value,
            .type = <%= node.c_type_enum_name %>
        },
        <%- node.fields.each do |field| -%>
        .<%= field.name %> = <%= field.name %>,
        <%- end -%>
    };

    return instance;
}

<%- end -%>

const char* get_class_name(VALUE o) {
    VALUE klass = rb_class_of(o);      // Get the class of the object
    VALUE klass_name = rb_class_name(klass);  // Get the name of the class
    const char* name = StringValueCStr(klass_name);  // Convert to C string
    return name;
}

VALUE rbs_struct_to_ruby_value(rbs_node_t *instance) {
    if (instance == NULL) {
        fprintf(stderr, "Tried to call rbs_struct_to_ruby_value(NULL)\n");
        exit(1);
    }

    VALUE ruby_value = instance->cached_ruby_value;

    if (ruby_value == Qnil || ruby_value == Qundef) {
        fprintf(stderr, "cached_ruby_value is NULL\n");
        exit(1);
    }

    const char *class_name = get_class_name(ruby_value);

    switch (instance->type) {
        <%- nodes.each do |node| -%>
        case <%= node.c_type_enum_name %>: {
            if (strcmp(class_name, "<%= node.full_name %>") != 0) {
                fprintf(stderr, "Expected class name: <%= node.full_name %>, got %s\n", class_name);
                exit(1);
            }
            break;
        }
        <%- end -%>
    }

    return instance->cached_ruby_value;
}
